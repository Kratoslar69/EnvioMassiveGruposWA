<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Env√≠o Masivo WhatsApp - TextMeBot MEJORADO</title>
    <meta name="description" content="Sistema web mejorado para env√≠o masivo de mensajes a grupos de WhatsApp usando TextMeBot API">
    <meta name="keywords" content="WhatsApp, env√≠o masivo, TextMeBot, grupos, mensajes">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: white;
            color: #25d366;
            border-bottom: 3px solid #25d366;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1e7dd;
            border: 1px solid #badbcc;
            color: #0f5132;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c2c7;
            color: #842029;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #664d03;
        }
        
        .groups-container {
            margin-top: 20px;
        }
        
        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .groups-search {
            flex: 1;
            margin-right: 15px;
        }
        
        .groups-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .groups-actions {
            display: flex;
            gap: 10px;
        }
        
        .group-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            border-color: #25d366;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.15);
        }
        
        .group-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .group-card h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .group-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .checkbox {
            transform: scale(1.2);
            margin-right: 8px;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
        }
        
        .status-item.success {
            border-left-color: #28a745;
        }
        
        .status-item.error {
            border-left-color: #dc3545;
        }
        
        .status-item.pending {
            border-left-color: #ffc107;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Mejoras espec√≠ficas */
        .enhanced-panel {
            background: #e8f5e8;
            border: 2px solid #25d366;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .retry-panel {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-btn.active {
            background: #25d366 !important;
            color: white !important;
        }

        .status-item.filtered-out {
            display: none !important;
        }

        .status-summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #25d366;
        }

        .summary-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .stat-number {
            font-weight: bold;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Env√≠o Masivo WhatsApp MEJORADO</h1>
            <p>Sistema de env√≠o de mensajes a m√∫ltiples grupos usando TextMeBot API</p>
            <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin: 10px 0;">
                <strong>üì± Versi√≥n 2.1 MEJORADA</strong> | ‚úÖ Detecci√≥n Autom√°tica | üîÑ Reenv√≠o con Archivos
            </div>
            <p style="font-size: 0.9em; opacity: 0.8;">
                üìñ <a href="javascript:void(0)" style="color: white;" onclick="showHelp()">Gu√≠a de Uso</a> | 
                üìÅ <a href="javascript:void(0)" style="color: white;" onclick="exportConfig()">Exportar Config Completa</a> |
                üë• <a href="javascript:void(0)" style="color: white;" onclick="exportGroupsOnly()">Exportar Solo Grupos</a>
            </p>
        </div>
        
        <div class="main-panel">
            <div class="tabs">
                <div class="tab active" data-tab="config">‚öôÔ∏è Configuraci√≥n</div>
                <div class="tab" data-tab="groups">üë• Grupos</div>
                <div class="tab" data-tab="message">üí¨ Mensaje</div>
                <div class="tab" data-tab="send">üì§ Enviar</div>
            </div>
            
            <div id="config-tab" class="tab-content">
                <h3>Configuraci√≥n de API</h3>
                <div class="form-group">
                    <label for="apikey">API Key de TextMeBot:</label>
                    <input type="password" id="apikey" class="form-control" placeholder="Ingresa tu API Key" value="DAwFasxdhqor">
                    <small style="color: #6c757d;">Obt√©n tu API Key en <a href="https://textmebot.com" target="_blank">textmebot.com</a></small>
                </div>
                
                <div class="form-group">
                    <label for="delay">Retraso entre env√≠os (segundos):</label>
                    <input type="number" id="delay" class="form-control" value="8" min="5" max="30">
                    <small style="color: #6c757d;">Recomendado: 8-10 segundos para evitar limitaciones. Con errores "8 sec delay needed" usar m√≠nimo 8 segundos.</small>
                </div>
                
                <button class="btn btn-primary" onclick="testConnection()">üîÑ Verificar Conexi√≥n</button>
                <div id="connection-status"></div>
            </div>
            
            <div id="groups-tab" class="tab-content hidden">
                <h3>Gesti√≥n de Grupos</h3>
                
                <div class="enhanced-panel">
                    <h4>üîç Agregar Grupo - M√©todo Original Mejorado</h4>
                    <div class="form-group">
                        <label for="invitation-code-original">C√≥digo de Invitaci√≥n del Grupo:</label>
                        <input type="text" id="invitation-code-original" class="form-control" placeholder="RTiy3mHqIDfD22H1InRR5E">
                        <small style="color: #6c757d;">Obt√©n el c√≥digo desde el enlace de invitaci√≥n de WhatsApp</small>
                    </div>
                    
                    <button class="btn btn-primary" onclick="addGroupOriginalMethod()">‚ûï Agregar Grupo (Auto-detectar)</button>
                    <div id="add-group-status-original"></div>
                </div>
                
                <div class="enhanced-panel" style="margin-top: 15px;">
                    <h4>üîß M√©todo Manual (Si el autom√°tico falla)</h4>
                    <div class="form-group">
                        <label for="invitation-input">Enlace o C√≥digo de Invitaci√≥n:</label>
                        <input type="text" id="invitation-input" class="form-control" placeholder="https://chat.whatsapp.com/RTiy3mHqIDfD22H1InRR5E o solo RTiy3mHqIDfD22H1InRR5E">
                        <small style="color: #6c757d;">Pega el enlace completo de WhatsApp o solo el c√≥digo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="group-name-input">Nombre del Grupo:</label>
                        <input type="text" id="group-name-input" class="form-control" placeholder="Nombre del grupo">
                        <small style="color: #6c757d;">Ingresa el nombre del grupo manualmente</small>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="addGroupImproved()">‚ûï Agregar Manual</button>
                    <button class="btn btn-warning" onclick="testSingleGroup()">üß™ Probar √öltimo Grupo</button>
                    <div id="add-group-status"></div>
                </div>
                
                <button class="btn btn-secondary" onclick="loadFromFile()">üìÅ Cargar desde Archivo</button>
                <button class="btn btn-success" onclick="exportGroupsOnly()">üíæ Exportar Solo Grupos</button>
                <button class="btn btn-danger" onclick="clearAllGroups()">üóëÔ∏è Limpiar Todo</button>
                
                <div class="groups-container">
                    <div class="groups-header">
                        <div class="groups-search">
                            <input type="text" id="groups-search" placeholder="üîç Buscar grupos por nombre..." onkeyup="filterGroups()">
                        </div>
                        <div class="groups-actions">
                            <button class="btn btn-sm btn-secondary" onclick="selectAll()">‚úÖ Todos</button>
                            <button class="btn btn-sm btn-secondary" onclick="selectNone()">‚ùå Ninguno</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleSort()" title="Cambiar orden">
                                üî§ <span id="sort-indicator">A-Z</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="groups-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; background: white;">
                        </div>
                    
                    <div class="status-panel">
                        <h4>Grupos Configurados: <span id="groups-count">0</span></h4>
                        <p>Selecciona los grupos a los que deseas enviar el mensaje</p>
                    </div>
                </div>
            </div>
            
            <div id="message-tab" class="tab-content hidden">
                <h3>Configurar Mensaje</h3>
                
                <div class="form-group">
                    <label for="message-type">Tipo de Mensaje:</label>
                    <select id="message-type" class="form-control" onchange="toggleMessageType()">
                        <option value="text">üìù Solo Texto</option>
                        <option value="image">üñºÔ∏è Texto + Imagen</option>
                        <option value="document">üìÑ Texto + Documento</option>
                        <option value="audio">üéµ Audio</option>
                        <option value="video">üé¨ Video</option>
                        <option value="link">üîó Enlace con Vista Previa</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="message-text">Texto del Mensaje:</label>
                    <textarea id="message-text" class="form-control" rows="6" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    <small style="color: #6c757d;">Puedes usar variables: {grupo}, {fecha}, {hora}</small>
                </div>
                
                <div id="file-section" class="form-group hidden">
                    <label for="file-url">URL del Archivo:</label>
                    <input type="url" id="file-url" class="form-control" placeholder="https://ejemplo.com/archivo.jpg">
                    <small style="color: #6c757d;">El archivo debe estar disponible p√∫blicamente en internet</small>
                </div>

                <div id="link-section" class="form-group hidden">
                    <label for="link-url">URL del Enlace con Vista Previa:</label>
                    <input type="url" id="link-url" class="form-control" placeholder="https://ejemplo.com/articulo">
                    <small style="color: #6c757d;">La URL debe ser p√∫blica para generar la vista previa</small>
                </div>
                
                <button class="btn btn-primary" onclick="previewMessage()">üëÅÔ∏è Vista Previa</button>
                <button class="btn btn-secondary" onclick="saveTemplate()">üíæ Guardar Plantilla</button>
                
                <div id="message-preview" class="status-panel hidden">
                    <h4>Vista Previa del Mensaje:</h4>
                    <div id="preview-content"></div>
                </div>
            </div>
            
            <div id="send-tab" class="tab-content hidden">
                <h3>Env√≠o Masivo</h3>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Importante:</strong> Aseg√∫rate de ser miembro de todos los grupos seleccionados. 
                    TextMeBot puede banear tu n√∫mero si intentas enviar a grupos donde no perteneces.
                </div>
                
                <div id="retry-panel" class="retry-panel hidden">
                    <h4>üîÑ Reenv√≠o de Mensajes con Errores MEJORADO</h4>
                    <div>
                        <p><strong>‚úÖ Incluye archivos adjuntos</strong></p>
                        <p><strong>‚úÖ Configuraci√≥n original completa</strong></p>
                        <p>Grupos con errores: <strong id="failed-count">0</strong></p>
                    </div>
                    <button class="btn btn-warning" onclick="retryFailedGroupsWithFiles()">üîÑ Reintentar Solo Errores (CON ARCHIVOS)</button>
                    <button class="btn btn-secondary" onclick="hideRetryPanel()">‚ùå Cerrar</button>
                </div>
                
                <div id="send-summary">
                    <h4>Resumen del Env√≠o:</h4>
                    <p><strong>Grupos seleccionados:</strong> <span id="selected-groups-count">0</span></p>
                    <p><strong>Tipo de mensaje:</strong> <span id="message-type-summary">-</span></p>
                    <p><strong>Retraso configurado:</strong> <span id="delay-summary">-</span> segundos</p>
                    <p><strong>Archivo adjunto:</strong> <span id="file-summary">-</span></p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="progress-text">Listo para enviar</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-success" id="send-btn" onclick="startSending()">üöÄ Iniciar Env√≠o Masivo</button>
                    <button class="btn btn-danger hidden" id="stop-btn" onclick="stopSending()">‚èπÔ∏è Detener Env√≠o</button>
                </div>
                
                <div id="status-filters" class="hidden" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Filtrar por estado:</strong>
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-secondary filter-btn active" data-filter="all" onclick="filterByStatus('all')">üìã Todos</button>
                        <button class="btn btn-sm btn-success filter-btn" data-filter="success" onclick="filterByStatus('success')">‚úÖ Exitosos</button>
                        <button class="btn btn-sm btn-danger filter-btn" data-filter="error" onclick="filterByStatus('error')">‚ùå Errores</button>
                        <button class="btn btn-sm btn-warning filter-btn" data-filter="pending" onclick="filterByStatus('pending')">‚è≥ Pendientes</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                        <span id="filter-stats">Mostrando todos los elementos</span>
                    </div>
                </div>
                
                <div class="status-panel" id="sending-status">
                    <h4>Estado del Env√≠o:</h4>
                    <div id="status-list" style="max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let groups = [];
        let sendingProcess = null;
        let currentTab = 'config';
        let filteredGroups = [];
        let sortDirection = 'asc';
        let lastSendingConfig = null; // Para guardar la config del √∫ltimo env√≠o
        let failedGroups = []; // Para rastrear grupos con errores
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Cargar configuraci√≥n guardada
            loadConfig();
            
            // Auto-guardar cada 30 segundos
            setInterval(saveConfig, 30000);
        });
        
        // FUNCI√ìN MEJORADA: Agregar grupo con mejor validaci√≥n de ID
        function addGroupImproved() {
            const invitationInput = document.getElementById('invitation-input').value.trim();
            const groupNameInput = document.getElementById('group-name-input').value.trim();
            
            if (!invitationInput) {
                showAlert('add-group-status', 'danger', '‚ùå Por favor ingresa un enlace o c√≥digo de invitaci√≥n');
                return;
            }
            
            if (!groupNameInput) {
                showAlert('add-group-status', 'danger', '‚ùå Por favor ingresa el nombre del grupo');
                return;
            }
            
            // Extraer c√≥digo de invitaci√≥n
            let invitationCode = extractInvitationCode(invitationInput);
            
            if (!invitationCode) {
                showAlert('add-group-status', 'danger', '‚ùå C√≥digo de invitaci√≥n inv√°lido');
                return;
            }
            
            // Verificar duplicados
            const existingGroup = groups.find(g => g.invitationCode === invitationCode);
            if (existingGroup) {
                showAlert('add-group-status', 'warning', `‚ö†Ô∏è El grupo "${existingGroup.name}" ya est√° agregado con este c√≥digo`);
                return;
            }
            
            // MEJORA: Crear ID m√°s realista para grupos de WhatsApp
            // Usar el c√≥digo de invitaci√≥n como base para el ID
            const groupId = `${invitationCode}@g.us`;
            
            // Crear grupo
            const group = {
                id: groupId,
                name: groupNameInput,
                invitationCode: invitationCode,
                selected: true,
                manual: true,
                dateAdded: new Date().toISOString()
            };
            
            groups.push(group);
            renderGroups();
            saveConfig();
            
            // Limpiar formulario
            document.getElementById('invitation-input').value = '';
            document.getElementById('group-name-input').value = '';
            
            showAlert('add-group-status', 'success', `‚úÖ Grupo "${groupNameInput}" agregado exitosamente\nüÜî ID: ${groupId}`);
            
            // Ocultar mensaje despu√©s de 3 segundos
            setTimeout(() => {
                document.getElementById('add-group-status').innerHTML = '';
            }, 3000);
        }
        
        // FUNCI√ìN MEJORADA: Extraer c√≥digo de invitaci√≥n
        function extractInvitationCode(input) {
            // Limpiar el input
            input = input.trim();
            
            // Si es un enlace completo
            if (input.includes('chat.whatsapp.com/')) {
                const match = input.match(/chat\.whatsapp\.com\/([A-Za-z0-9_-]+)/);
                return match ? match[1] : null;
            }
            
            // Si es solo el c√≥digo
            if (/^[A-Za-z0-9_-]+$/.test(input) && input.length > 10) {
                return input;
            }
            
            return null;
        }
        
        // FUNCI√ìN MEJORADA: Reenv√≠o con archivos incluidos
        async function retryFailedGroupsWithFiles() {
            if (failedGroups.length === 0) {
                alert('No hay grupos con errores para reintentar');
                return;
            }
            
            if (!lastSendingConfig) {
                alert('No se encontr√≥ la configuraci√≥n del √∫ltimo env√≠o');
                return;
            }
            
            const confirmed = confirm(`¬øReintentar env√≠o a ${failedGroups.length} grupos con errores?\n\n‚úÖ Se incluir√°n archivos adjuntos\n‚úÖ Se usar√° la configuraci√≥n original\n‚úÖ No se enviar√°n duplicados a grupos exitosos`);
            
            if (!confirmed) {
                return;
            }
            
            // Ocultar panel de reintento
            hideRetryPanel();
            
            // Configurar interfaz para reintento
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            
            const statusList = document.getElementById('status-list');
            let sent = 0;
            const total = failedGroups.length;
            sendingProcess = true;
            
            // Actualizar progreso
            document.getElementById('progress-text').textContent = `Reintentando con archivos: 0/${total}`;
            
            // Limpiar elementos de error anteriores para grupos que se van a reintentar
            const errorItems = document.querySelectorAll('.status-item.error');
            errorItems.forEach(item => {
                const groupName = item.querySelector('span').textContent;
                if (failedGroups.some(g => g.name === groupName)) {
                    item.remove();
                }
            });
            
            for (let i = 0; i < failedGroups.length; i++) {
                if (!sendingProcess) {
                    break;
                }
                
                const group = failedGroups[i];
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item pending';
                statusItem.innerHTML = `
                    <span>${group.name}</span>
                    <span>üîÑ Reintentando (con archivos)...</span>
                `;
                statusList.appendChild(statusItem);
                
                try {
                    // Usar configuraci√≥n original del √∫ltimo env√≠o
                    const messageText = lastSendingConfig.text.replace('{grupo}', group.name)
                                                              .replace('{fecha}', new Date().toLocaleDateString())
                                                              .replace('{hora}', new Date().toLocaleTimeString());
                    
                    console.log(`Reintentando env√≠o a: ${group.name} con configuraci√≥n original`);
                    
                    // USAR LA MISMA L√ìGICA DE ENV√çO CON ARCHIVOS
                    const proxyUrl = 'https://api.allorigins.win/get?url=';
                    let targetUrl = `http://api.textmebot.com/send.php?recipient=${encodeURIComponent(group.id)}&apikey=${encodeURIComponent(lastSendingConfig.apikey)}&text=${encodeURIComponent(messageText)}&json=yes`;
                    
                    // AGREGAR ARCHIVOS SI ESTABAN EN LA CONFIGURACI√ìN ORIGINAL
                    if (lastSendingConfig.messageType !== 'text' && lastSendingConfig.fileUrl) {
                        const fileUrl = lastSendingConfig.fileUrl.trim();
                        
                        switch (lastSendingConfig.messageType) {
                            case 'image':
                            case 'video':
                                targetUrl += `&file=${encodeURIComponent(fileUrl)}`;
                                break;
                            case 'audio':
                                targetUrl += `&audio=${encodeURIComponent(fileUrl)}`;
                                break;
                            case 'document':
                                targetUrl += `&document=${encodeURIComponent(fileUrl)}`;
                                break;
                        }
                    }
                    
                    const sendUrl = proxyUrl + encodeURIComponent(targetUrl);
                    console.log('URL de reintento:', targetUrl);
                    
                    const response = await fetch(sendUrl);
                    const data = await response.json();
                    const resultText = data.contents;
                    
                    console.log(`Respuesta reintento ${group.name}:`, resultText);
                    
                    let success = false;
                    let errorMessage = 'Error desconocido';
                    
                    try {
                        const result = JSON.parse(resultText);
                        if (result.status === 'success') {
                            success = true;
                        } else {
                            errorMessage = result.comment || result.msg || 'Error en el env√≠o';
                        }
                    } catch (parseError) {
                        // Verificar respuestas HTML
                        if (resultText.includes('Success!') || resultText.includes('success')) {
                            success = true;
                        } else if (resultText.includes('Failed') || resultText.includes('ERROR')) {
                            errorMessage = 'Error en el env√≠o';
                        } else if (resultText.includes('Invalid APIkey')) {
                            errorMessage = 'API Key inv√°lida';
                        } else if (resultText.includes('You are not member')) {
                            errorMessage = 'No eres miembro de este grupo';
                        } else if (resultText.includes('Delay needed') || resultText.includes('8 sec')) {
                            errorMessage = '8 sec. Delay needed';
                        } else {
                            success = true;
                        }
                    }
                    
                    if (success) {
                        statusItem.className = 'status-item success';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚úÖ Reintento exitoso ${lastSendingConfig.fileUrl ? '(con archivo)' : ''}</span>
                        `;
                        sent++;
                        
                        // Remover de la lista de fallos
                        failedGroups = failedGroups.filter(fg => fg.name !== group.name);
                    } else {
                        statusItem.className = 'status-item error';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚ùå ${errorMessage}</span>
                        `;
                    }
                    
                } catch (error) {
                    statusItem.className = 'status-item error';
                    statusItem.innerHTML = `
                        <span>${group.name}</span>
                        <span>‚ùå Error: ${error.message}</span>
                    `;
                }
                
                // Actualizar progreso
                const progress = ((i + 1) / total) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-text').textContent = 
                    `Reintentando: ${i + 1}/${total} (${sent} exitosos)`;
                
                // Esperar antes del siguiente env√≠o
                if (i < failedGroups.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, lastSendingConfig.delay * 1000));
                }
            }
            
            // Finalizar reintento
            document.getElementById('send-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('progress-text').textContent = 
                `Reintento completado: ${sent}/${total} exitosos`;
            
            // Mostrar bot√≥n de reintento si a√∫n hay errores
            if (failedGroups.length > 0) {
                showRetryPanel();
            }
            
            sendingProcess = null;
        }
        
        // Funci√≥n para mostrar panel de reintento
        function showRetryPanel() {
            if (failedGroups.length === 0) {
                return;
            }
            
            document.getElementById('failed-count').textContent = failedGroups.length;
            document.getElementById('retry-panel').classList.remove('hidden');
        }
        
        // Funci√≥n para ocultar panel de reintento
        function hideRetryPanel() {
            document.getElementById('retry-panel').classList.add('hidden');
        }
        
        // Gesti√≥n de pesta√±as
        function switchTab(tab) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Quitar clase active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tab + '-tab').classList.remove('hidden');
            
            // Activar pesta√±a clickeada
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            currentTab = tab;
            
            if (tab === 'send') {
                updateSendSummary();
            }
        }
        
        // Verificar conexi√≥n con la API
        async function testConnection() {
            const apikey = document.getElementById('apikey').value;
            if (!apikey) {
                showAlert('connection-status', 'danger', 'Por favor ingresa tu API Key');
                return;
            }
            
            try {
                showAlert('connection-status', 'warning', 'Verificando conexi√≥n...');
                
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = `http://api.textmebot.com/send.php?recipient=123456789&apikey=${encodeURIComponent(apikey)}&text=test&json=yes`;
                const testUrl = proxyUrl + encodeURIComponent(targetUrl);
                
                const response = await fetch(testUrl);
                const data = await response.json();
                const result = data.contents;
                
                if (result.includes('Invalid APIkey') || result.includes('Invalid Premium APIkey')) {
                    showAlert('connection-status', 'danger', '‚ùå API Key inv√°lida');
                } else {
                    showAlert('connection-status', 'success', '‚úÖ Conexi√≥n exitosa - API Key v√°lida');
                    saveConfig();
                }
            } catch (error) {
                showAlert('connection-status', 'success', '‚úÖ Modo manual activado. Puedes agregar grupos directamente.');
                saveConfig();
            }
        }
        
        // Ordenar grupos
        function sortGroups() {
            groups.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                
                if (sortDirection === 'asc') {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });
        }
        
        // Alternar orden
        function toggleSort() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            document.getElementById('sort-indicator').textContent = sortDirection === 'asc' ? 'A-Z' : 'Z-A';
            renderGroups();
            saveConfig();
        }
        
        // Renderizar grupos
        function renderGroups() {
            sortGroups();
            
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('groups-search')?.value.toLowerCase() || '';
            filteredGroups = groups.filter(group => 
                group.name.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.invitationCode.toLowerCase().includes(searchTerm)
            );
            
            filteredGroups.forEach((group, index) => {
                const card = document.createElement('div');
                card.className = `group-card ${group.selected ? 'selected' : ''}`;
                card.innerHTML = `
                    <h4>${group.name}</h4>
                    <div class="group-info">ID: ${group.id}</div>
                    <div class="group-info">C√≥digo: ${group.invitationCode}</div>
                    ${group.dateAdded ? `<div class="group-info">Agregado: ${new Date(group.dateAdded).toLocaleString()}</div>` : ''}
                    <label>
                        <input type="checkbox" class="checkbox" ${group.selected ? 'checked' : ''} 
                               onchange="toggleGroupSelection(${groups.indexOf(group)})">
                        Incluir en env√≠o
                    </label>
                    <button class="btn btn-danger btn-sm" onclick="removeGroup(${groups.indexOf(group)})" style="margin-top: 10px;">Eliminar</button>
                `;
                container.appendChild(card);
            });
            
            document.getElementById('groups-count').textContent = groups.length;
        }
        
        // Toggle selecci√≥n de grupo
        function toggleGroupSelection(index) {
            groups[index].selected = !groups[index].selected;
            renderGroups();
            saveConfig();
        }
        
        // Eliminar grupo
        function removeGroup(index) {
            if (confirm('¬øEliminar este grupo?')) {
                groups.splice(index, 1);
                renderGroups();
                saveConfig();
            }
        }
        
        // Seleccionar todos
        function selectAll() {
            groups.forEach(group => {
                group.selected = true;
            });
            renderGroups();
            saveConfig();
        }
        
        // Deseleccionar todos
        function selectNone() {
            groups.forEach(group => {
                group.selected = false;
            });
            renderGroups();
            saveConfig();
        }
        
        // Limpiar todos los grupos
        function clearAllGroups() {
            if (confirm('¬øEliminar todos los grupos?')) {
                groups = [];
                renderGroups();
                saveConfig();
            }
        }
        
        // Filtrar grupos
        function filterGroups() {
            renderGroups();
        }
        
        // Cambiar tipo de mensaje
        function toggleMessageType() {
            const type = document.getElementById('message-type').value;
            const fileSection = document.getElementById('file-section');
            const linkSection = document.getElementById('link-section'); // Seleccionamos la nueva secci√≥n de enlace

            // Ocultamos ambas secciones por defecto
            fileSection.classList.add('hidden');
            linkSection.classList.add('hidden');
            
            // Mostramos la secci√≥n que corresponda al tipo de mensaje
            if (type === 'link') {
                linkSection.classList.remove('hidden');
            } else if (type !== 'text') {
                fileSection.classList.remove('hidden');
            }
        }
        
        // Vista previa del mensaje
        function previewMessage() {
            const text = document.getElementById('message-text').value;
            const type = document.getElementById('message-type').value;
            const fileUrl = document.getElementById('file-url').value;
            const linkUrl = document.getElementById('link-url').value; // Obtenemos la URL del enlace
            
            let preview = text.replace('{grupo}', 'Grupo de Ejemplo')
                             .replace('{fecha}', new Date().toLocaleDateString())
                             .replace('{hora}', new Date().toLocaleTimeString());
            
            let content = `<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #25d366;">`;
            content += `<strong>Tipo:</strong> ${type}<br>`;
            content += `<strong>Texto:</strong><br>${preview.replace(/\n/g, '<br>')}`;
            
            // Modificamos la l√≥gica para la vista previa del enlace
            if (type === 'link' && linkUrl) {
                content += `<br><br><strong>Enlace con Vista Previa:</strong><br>`;
                content += `<a href="${linkUrl}" target="_blank" style="color: #25d366;">${linkUrl}</a>`;
            } else if (type !== 'text' && fileUrl) {
                content += `<br><br><strong>Archivo adjunto:</strong><br>`;
                content += `<a href="${fileUrl}" target="_blank" style="color: #25d366;">${fileUrl}</a>`;
            }
            content += `</div>`;
            
            document.getElementById('preview-content').innerHTML = content;
            document.getElementById('message-preview').classList.remove('hidden');
        }
        
        // Actualizar resumen de env√≠o
        function updateSendSummary() {
            const selectedCount = groups.filter(g => g.selected).length;
            const messageType = document.getElementById('message-type').value;
            const delay = document.getElementById('delay').value;
            const fileUrl = document.getElementById('file-url').value;
            const linkUrl = document.getElementById('link-url').value; // Obtenemos la URL del enlace
            
            document.getElementById('selected-groups-count').textContent = selectedCount;
            document.getElementById('message-type-summary').textContent = messageType;
            document.getElementById('delay-summary').textContent = delay;
            
            // Mostrar informaci√≥n del archivo/enlace en el resumen
            const fileSummary = document.getElementById('file-summary');
            if (messageType === 'link' && linkUrl) {
                const linkName = linkUrl.split('/').pop();
                fileSummary.textContent = linkName;
                fileSummary.style.color = '#25d366';
            } else if (messageType !== 'text' && fileUrl) {
                const fileName = fileUrl.split('/').pop();
                fileSummary.textContent = fileName;
                fileSummary.style.color = '#25d366';
            } else {
                fileSummary.textContent = 'Sin archivo';
                fileSummary.style.color = '#6c757d';
            }
        }
        
        // Iniciar env√≠o masivo
        async function startSending() {
            const selectedGroups = groups.filter(g => g.selected);
            if (selectedGroups.length === 0) {
                alert('Selecciona al menos un grupo');
                return;
            }
            
            const apikey = document.getElementById('apikey').value;
            const text = document.getElementById('message-text').value;
            const delay = parseInt(document.getElementById('delay').value);
            const messageType = document.getElementById('message-type').value;
            const fileUrl = document.getElementById('file-url').value;
            const linkUrl = document.getElementById('link-url').value; // Obtenemos la URL del enlace
            
            if (!apikey || !text) {
                alert('Completa la configuraci√≥n y el mensaje');
                return;
            }
            
            // Guardar configuraci√≥n del env√≠o para reenv√≠os
            lastSendingConfig = {
                apikey: apikey,
                text: text,
                delay: delay,
                messageType: messageType,
                fileUrl: fileUrl,
                linkUrl: linkUrl, // Guardamos la URL del enlace
                timestamp: new Date().toISOString()
            };
            
            // Limpiar lista de fallos anteriores
            failedGroups = [];
            
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            
            const statusList = document.getElementById('status-list');
            statusList.innerHTML = '';
            
            let sent = 0;
            const total = selectedGroups.length;
            sendingProcess = true;
            
            // Mostrar filtros
            document.getElementById('status-filters').classList.remove('hidden');
            
            for (let i = 0; i < selectedGroups.length; i++) {
                if (!sendingProcess) {
                    break;
                }
                
                const group = selectedGroups[i];
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item pending';
                statusItem.innerHTML = `
                    <span>${group.name}</span>
                    <span>Enviando${fileUrl || linkUrl ? ' (con adjunto)' : ''}...</span>
                `;
                statusList.appendChild(statusItem);
                
                try {
                    const messageText = text.replace('{grupo}', group.name)
                                          .replace('{fecha}', new Date().toLocaleDateString())
                                          .replace('{hora}', new Date().toLocaleTimeString());
                    
                    // MEJORA: Usar el c√≥digo de invitaci√≥n como recipient para grupos manuales
                    let recipientId = group.id;
                    
                    // Si es un grupo manual o agregado con el m√©todo original, usar diferentes estrategias
                    if (group.manual || group.auto) {
                        // Para grupos manuales, probar primero con el c√≥digo de invitaci√≥n
                        recipientId = group.invitationCode;
                        console.log(`Grupo ${group.manual ? 'manual' : 'autom√°tico'}: usando c√≥digo como recipient: ${recipientId}`);
                    }
                    
                    // Usar proxy CORS para env√≠o
                    const proxyUrl = 'https://api.allorigins.win/get?url=';
                    let targetUrl = `http://api.textmebot.com/send.php?recipient=${encodeURIComponent(recipientId)}&apikey=${encodeURIComponent(apikey)}&text=${encodeURIComponent(messageText)}&json=yes`;
                    
                    // NUEVA L√ìGICA: AGREGAR EL PAR√ÅMETRO 'link' PARA ENLACES
                    if (messageType === 'link' && linkUrl) {
                        const cleanLinkUrl = linkUrl.trim();
                        targetUrl += `&link=${encodeURIComponent(cleanLinkUrl)}`;
                    } else if (messageType !== 'text' && fileUrl) {
                        const cleanFileUrl = fileUrl.trim();
                        
                        switch (messageType) {
                            case 'image':
                            case 'video':
                                targetUrl += `&file=${encodeURIComponent(cleanFileUrl)}`;
                                break;
                            case 'audio':
                                targetUrl += `&audio=${encodeURIComponent(cleanFileUrl)}`;
                                break;
                            case 'document':
                                targetUrl += `&document=${encodeURIComponent(cleanFileUrl)}`;
                                break;
                        }
                    }
                    
                    const sendUrl = proxyUrl + encodeURIComponent(targetUrl);
                    console.log('URL de env√≠o:', targetUrl);
                    
                    const response = await fetch(sendUrl);
                    const data = await response.json();
                    const resultText = data.contents;
                    
                    console.log('Respuesta del servidor:', resultText);
                    
                    let success = false;
                    let errorMessage = 'Error desconocido';
                    
                    // MEJORA: Mejor manejo de respuestas de error
                    try {
                        // Intentar parsear como JSON primero
                        const result = JSON.parse(resultText);
                        if (result.status === 'success') {
                            success = true;
                        } else {
                            errorMessage = result.comment || result.msg || 'Error en el env√≠o';
                            
                            // Si falla con c√≥digo de invitaci√≥n, intentar con ID del grupo
                            if (recipientId === group.invitationCode && group.id !== group.invitationCode) {
                                console.log('Intentando con ID del grupo:', group.id);
                                // Hacer segundo intento con el ID
                                recipientId = group.id;
                                targetUrl = `http://api.textmebot.com/send.php?recipient=${encodeURIComponent(recipientId)}&apikey=${encodeURIComponent(apikey)}&text=${encodeURIComponent(messageText)}&json=yes`;
                                
                                // Volvemos a agregar el adjunto para el segundo intento
                                if (messageType === 'link' && linkUrl) {
                                    targetUrl += `&link=${encodeURIComponent(linkUrl.trim())}`;
                                } else if (messageType !== 'text' && fileUrl) {
                                    const cleanFileUrl = fileUrl.trim();
                                    switch (messageType) {
                                        case 'image':
                                        case 'video':
                                            targetUrl += `&file=${encodeURIComponent(cleanFileUrl)}`;
                                            break;
                                        case 'audio':
                                            targetUrl += `&audio=${encodeURIComponent(cleanFileUrl)}`;
                                            break;
                                        case 'document':
                                            targetUrl += `&document=${encodeURIComponent(cleanFileUrl)}`;
                                            break;
                                    }
                                }
                                
                                const secondSendUrl = proxyUrl + encodeURIComponent(targetUrl);
                                const secondResponse = await fetch(secondSendUrl);
                                const secondData = await secondResponse.json();
                                const secondResultText = secondData.contents;
                                
                                console.log('Segunda respuesta:', secondResultText);
                                
                                try {
                                    const secondResult = JSON.parse(secondResultText);
                                    if (secondResult.status === 'success') {
                                        success = true;
                                    } else {
                                        errorMessage = secondResult.comment || secondResult.msg || errorMessage;
                                    }
                                } catch (secondParseError) {
                                    if (secondResultText.includes('Success!') || secondResultText.includes('success')) {
                                        success = true;
                                    }
                                }
                            }
                        }
                    } catch (parseError) {
                        // Si no es JSON v√°lido, analizar el contenido HTML/texto
                        console.log('No es JSON v√°lido, analizando contenido:', resultText.substring(0, 200));
                        
                        if (resultText.includes('Success!') || resultText.includes('success')) {
                            success = true;
                        } else if (resultText.includes('Failed') || resultText.includes('ERROR')) {
                            errorMessage = 'Error en el env√≠o';
                        } else if (resultText.includes('Invalid APIkey')) {
                            errorMessage = 'API Key inv√°lida';
                        } else if (resultText.includes('You are not member of this group')) {
                            errorMessage = 'No eres miembro de este grupo';
                        } else if (resultText.includes('Delay needed') || resultText.includes('8 sec')) {
                            errorMessage = '8 sec. Delay needed';
                        } else if (resultText.includes('Recipient format is incorrect')) {
                            errorMessage = 'Formato de destinatario incorrecto';
                        } else if (resultText.includes('Oops') || resultText.includes('Error')) {
                            // Extraer mensaje de error m√°s espec√≠fico
                            const errorMatch = resultText.match(/Oops[^<]*|Error[^<]*/i);
                            errorMessage = errorMatch ? errorMatch[0].substring(0, 100) : 'Error del servidor';
                        } else if (resultText.includes('<!DOCTYPE') || resultText.includes('<html>')) {
                            errorMessage = 'Respuesta HTML inesperada del servidor';
                        } else {
                            // Si no hay error claro pero tampoco √©xito, considerar como error
                            errorMessage = `Respuesta inesperada: ${resultText.substring(0, 50)}...`;
                        }
                    }
                    
                    if (success) {
                        statusItem.className = 'status-item success';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚úÖ Enviado${fileUrl ? ' (con archivo)' : linkUrl ? ' (con enlace)' : ''}</span>
                        `;
                        sent++;
                        console.log(`‚úÖ Enviado a ${group.name}`);
                    } else {
                        statusItem.className = 'status-item error';
                        statusItem.innerHTML = `
                            <span>${group.name}</span>
                            <span>‚ùå ${errorMessage}</span>
                        `;
                        console.error(`‚ùå Error en ${group.name}: ${errorMessage}`);
                        
                        // Agregar a lista de fallos para reenv√≠o posterior
                        failedGroups.push({
                            ...group,
                            error: errorMessage
                        });
                    }
                    
                } catch (error) {
                    console.error('Error general:', error);
                    statusItem.className = 'status-item error';
                    statusItem.innerHTML = `
                        <span>${group.name}</span>
                        <span>‚ùå Error: ${error.message}</span>
                    `;
                    
                    failedGroups.push({
                        ...group,
                        error: error.message
                    });
                }
                
                // Actualizar progreso
                const progress = ((i + 1) / total) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-text').textContent = 
                    `Progreso: ${i + 1}/${total} (${sent} exitosos)`;
                
                // Esperar antes del siguiente env√≠o
                if (i < selectedGroups.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * 1000));
                }
            }
            
            document.getElementById('send-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('progress-text').textContent = 
                `Completado: ${sent}/${total} mensajes enviados`;
            
            // Mostrar resumen
            showSendingSummary(sent, failedGroups.length, total);
            
            // Mostrar panel de reintento si hay errores
            if (failedGroups.length > 0) {
                showRetryPanel();
            }
            
            sendingProcess = null;
        }
        
        // Detener env√≠o
        function stopSending() {
            sendingProcess = false;
            document.getElementById('send-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('progress-text').textContent = 'Env√≠o detenido por el usuario';
        }
        
        // Filtrar resultados por estado
        function filterByStatus(status) {
            // Actualizar botones de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');
            
            // Obtener todos los elementos de estado
            const statusItems = document.querySelectorAll('.status-item');
            let visibleCount = 0;
            
            statusItems.forEach(item => {
                const isSuccess = item.classList.contains('success');
                const isError = item.classList.contains('error');
                const isPending = item.classList.contains('pending');
                
                let shouldShow = false;
                
                switch(status) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'success':
                        shouldShow = isSuccess;
                        break;
                    case 'error':
                        shouldShow = isError;
                        break;
                    case 'pending':
                        shouldShow = isPending;
                        break;
                }
                
                if (shouldShow) {
                    item.classList.remove('filtered-out');
                    visibleCount++;
                } else {
                    item.classList.add('filtered-out');
                }
            });
            
            // Actualizar estad√≠sticas del filtro
            const filterStats = document.getElementById('filter-stats');
            const statusNames = {
                'all': 'todos los elementos',
                'success': 'env√≠os exitosos',
                'error': 'errores de env√≠o',
                'pending': 'elementos pendientes'
            };
            
            filterStats.textContent = `Mostrando ${visibleCount} ${statusNames[status]}`;
        }
        
        // Mostrar resumen de env√≠o
        function showSendingSummary(sent, failed, total) {
            const summaryHtml = `
                <div class="status-summary">
                    <h4>üìä Resumen del Env√≠o Masivo</h4>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span>‚úÖ Exitosos:</span>
                            <span class="stat-number" style="color: #28a745;">${sent}</span>
                        </div>
                        <div class="stat-item">
                            <span>‚ùå Errores:</span>
                            <span class="stat-number" style="color: #dc3545;">${failed}</span>
                        </div>
                        <div class="stat-item">
                            <span>üìã Total:</span>
                            <span class="stat-number">${total}</span>
                        </div>
                        <div class="stat-item">
                            <span>üìà Tasa de √©xito:</span>
                            <span class="stat-number" style="color: #25d366;">${Math.round((sent/total)*100)}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            const statusList = document.getElementById('status-list');
            statusList.insertAdjacentHTML('afterbegin', summaryHtml);
        }
        
        // FUNCI√ìN ORIGINAL MEJORADA: Agregar grupo como en el sistema original
        async function addGroupOriginalMethod() {
            const invitationCode = document.getElementById('invitation-code-original').value.trim();
            const apikey = document.getElementById('apikey').value;
            
            if (!invitationCode) {
                showAlert('add-group-status-original', 'danger', '‚ùå Por favor ingresa el c√≥digo de invitaci√≥n');
                return;
            }
            
            if (!apikey) {
                showAlert('add-group-status-original', 'danger', '‚ùå Por favor configura tu API Key primero');
                return;
            }
            
            try {
                showAlert('add-group-status-original', 'warning', 'üîç Obteniendo informaci√≥n del grupo...');
                
                // Usar el mismo m√©todo que el sistema original
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = `http://api.textmebot.com/send.php?apikey=${encodeURIComponent(apikey)}&group_info=${encodeURIComponent(invitationCode)}&json=yes`;
                const requestUrl = proxyUrl + encodeURIComponent(targetUrl);
                
                console.log('Consultando grupo con URL:', targetUrl);
                
                const response = await fetch(requestUrl);
                const data = await response.json();
                const resultText = data.contents;
                
                console.log('Respuesta de group_info:', resultText);
                
                try {
                    const result = JSON.parse(resultText);
                    
                    if (result.status === 'success' || result.group_id) {
                        const group = {
                            id: result.group_id || `${invitationCode}@g.us`,
                            name: result.subject || result.group_name || `Grupo ${invitationCode}`,
                            invitationCode: invitationCode,
                            selected: true,
                            auto: true,
                            dateAdded: new Date().toISOString()
                        };
                        
                        // Verificar duplicados
                        const existingGroup = groups.find(g => g.invitationCode === invitationCode);
                        if (existingGroup) {
                            showAlert('add-group-status-original', 'warning', `‚ö†Ô∏è El grupo "${existingGroup.name}" ya est√° agregado`);
                            return;
                        }
                        
                        groups.push(group);
                        renderGroups();
                        document.getElementById('invitation-code-original').value = '';
                        saveConfig();
                        
                        showAlert('add-group-status-original', 'success', `‚úÖ Grupo "${group.name}" agregado exitosamente\nüÜî ID: ${group.id}`);
                        
                    } else {
                        // Si la API no devuelve informaci√≥n v√°lida, intentar m√©todo manual
                        throw new Error(result.msg || result.comment || 'No se pudo obtener informaci√≥n del grupo');
                    }
                } catch (parseError) {
                    console.log('No se pudo parsear como JSON, intentando m√©todo manual');
                    
                    // Verificar si la respuesta contiene informaci√≥n de error espec√≠fica
                    if (resultText.includes('Invalid APIkey')) {
                        showAlert('add-group-status-original', 'danger', '‚ùå API Key inv√°lida');
                        return;
                    } else if (resultText.includes('Invalid group') || resultText.includes('not found')) {
                        showAlert('add-group-status-original', 'danger', '‚ùå C√≥digo de invitaci√≥n inv√°lido o grupo no encontrado');
                        return;
                    }
                    
                    // M√©todo de fallback: agregar manualmente
                    const groupName = prompt('No se pudo obtener el nombre autom√°ticamente. ¬øCu√°l es el nombre del grupo?', `Grupo ${invitationCode.substring(0, 8)}`);
                    if (groupName) {
                        addGroupManuallyOriginal(invitationCode, groupName);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('add-group-status-original', 'danger', `‚ùå Error de conexi√≥n: ${error.message}`);
                
                // Ofrecer m√©todo manual como alternativa
                setTimeout(() => {
                    showAlert('add-group-status-original', 'warning', 'üí° Usa el m√©todo manual abajo si el autom√°tico falla');
                }, 3000);
            }
        }
        
        // FUNCI√ìN AUXILIAR: Agregar grupo manualmente desde m√©todo original
        function addGroupManuallyOriginal(invitationCode, groupName) {
            // Verificar duplicados
            const existingGroup = groups.find(g => g.invitationCode === invitationCode);
            if (existingGroup) {
                showAlert('add-group-status-original', 'warning', `‚ö†Ô∏è El grupo "${existingGroup.name}" ya est√° agregado`);
                return;
            }
            
            const group = {
                id: `${invitationCode}@g.us`,
                name: groupName,
                invitationCode: invitationCode,
                selected: true,
                manual: true,
                dateAdded: new Date().toISOString()
            };
            
            groups.push(group);
            renderGroups();
            document.getElementById('invitation-code-original').value = '';
            saveConfig();
            
            showAlert('add-group-status-original', 'success', `‚úÖ Grupo "${groupName}" agregado manualmente\nüÜî ID: ${group.id}`);
        }
        async function testSingleGroup() {
            if (groups.length === 0) {
                alert('No hay grupos para probar. Agrega un grupo primero.');
                return;
            }
            
            const lastGroup = groups[groups.length - 1];
            const apikey = document.getElementById('apikey').value;
            
            if (!apikey) {
                alert('Configura tu API Key primero');
                return;
            }
            
            const confirmed = confirm(`¬øProbar env√≠o al grupo "${lastGroup.name}"?\n\nID: ${lastGroup.id}\nC√≥digo: ${lastGroup.invitationCode}\n\nEsto enviar√° un mensaje de prueba.`);
            
            if (!confirmed) {
                return;
            }
            
            try {
                showAlert('add-group-status', 'warning', 'üß™ Probando grupo...');
                
                const testMessage = `üß™ Prueba de conexi√≥n - ${new Date().toLocaleTimeString()}`;
                
                // Usar el c√≥digo de invitaci√≥n como recipient
                let recipientId = lastGroup.manual && lastGroup.invitationCode ? lastGroup.invitationCode : lastGroup.id;
                
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = `http://api.textmebot.com/send.php?recipient=${encodeURIComponent(recipientId)}&apikey=${encodeURIComponent(apikey)}&text=${encodeURIComponent(testMessage)}&json=yes`;
                const sendUrl = proxyUrl + encodeURIComponent(targetUrl);
                
                console.log('URL de prueba:', targetUrl);
                
                const response = await fetch(sendUrl);
                const data = await response.json();
                const resultText = data.contents;
                
                console.log('Respuesta de prueba:', resultText);
                
                let success = false;
                let errorMessage = 'Error desconocido';
                
                try {
                    const result = JSON.parse(resultText);
                    if (result.status === 'success') {
                        success = true;
                    } else {
                        errorMessage = result.comment || result.msg || 'Error en el env√≠o';
                    }
                } catch (parseError) {
                    if (resultText.includes('Success!') || resultText.includes('success')) {
                        success = true;
                    } else if (resultText.includes('Oops') || resultText.includes('Error')) {
                        const errorMatch = resultText.match(/Oops[^<]*|Error[^<]*/i);
                        errorMessage = errorMatch ? errorMatch[0].substring(0, 100) : 'Error del servidor';
                    } else if (resultText.includes('Invalid APIkey')) {
                        errorMessage = 'API Key inv√°lida';
                    } else if (resultText.includes('You are not member')) {
                        errorMessage = 'No eres miembro de este grupo';
                    } else if (resultText.includes('<!DOCTYPE') || resultText.includes('<html>')) {
                        errorMessage = 'El servidor devolvi√≥ HTML en lugar de JSON';
                    } else {
                        errorMessage = `Respuesta inesperada: ${resultText.substring(0, 50)}...`;
                    }
                }
                
                if (success) {
                    showAlert('add-group-status', 'success', `‚úÖ Prueba exitosa al grupo "${lastGroup.name}"\n\nEl grupo est√° configurado correctamente.`);
                } else {
                    showAlert('add-group-status', 'danger', `‚ùå Error en prueba: ${errorMessage}\n\nRevisa la configuraci√≥n del grupo.`);
                }
                
            } catch (error) {
                showAlert('add-group-status', 'danger', `‚ùå Error de conexi√≥n: ${error.message}`);
            }
            
            // Limpiar mensaje despu√©s de 10 segundos
            setTimeout(() => {
                document.getElementById('add-group-status').innerHTML = '';
            }, 10000);
        }
        function exportGroupsOnly() {
            if (groups.length === 0) {
                alert('No hay grupos para exportar');
                return;
            }
            
            const groupsData = {
                groups: groups,
                totalGroups: groups.length,
                selectedGroups: groups.filter(g => g.selected).length,
                exportDate: new Date().toISOString(),
                exportType: 'groups-only',
                version: '2.1-mejorada'
            };
            
            const blob = new Blob([JSON.stringify(groupsData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whatsapp-grupos-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exportados ${groups.length} grupos exitosamente\n\nArchivo: whatsapp-grupos-${new Date().toISOString().split('T')[0]}.json`);
        }
        
        // FUNCI√ìN MEJORADA: Cargar desde archivo (ahora detecta si son solo grupos)
        function loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            let data;
                            if (file.name.endsWith('.json')) {
                                data = JSON.parse(event.target.result);
                                
                                // Detectar si es archivo de solo grupos o configuraci√≥n completa
                                if (data.exportType === 'groups-only' && data.groups) {
                                    // Confirmar antes de reemplazar grupos existentes
                                    if (groups.length > 0) {
                                        const replace = confirm(`¬øReemplazar los ${groups.length} grupos actuales con los ${data.groups.length} grupos del archivo?\n\n‚úÖ Se mantendr√°n todos los datos de grupos\n‚ö†Ô∏è Se perder√°n los grupos actuales`);
                                        if (!replace) {
                                            return;
                                        }
                                    }
                                    
                                    groups = data.groups;
                                    renderGroups();
                                    saveConfig();
                                    alert(`‚úÖ Cargados ${data.groups.length} grupos exitosamente\n\nFecha de exportaci√≥n: ${new Date(data.exportDate).toLocaleString()}`);
                                    
                                } else if (Array.isArray(data)) {
                                    // Formato legacy de array de grupos
                                    groups = data;
                                    renderGroups();
                                    saveConfig();
                                    alert(`‚úÖ Cargados ${data.length} grupos (formato legacy)`);
                                    
                                } else if (data.groups) {
                                    // Configuraci√≥n completa
                                    const loadComplete = confirm(`El archivo contiene configuraci√≥n completa (grupos + mensajes + configuraci√≥n).\n\n¬øCargar solo los grupos o toda la configuraci√≥n?\n\n‚úÖ OK = Solo grupos\n‚ùå Cancelar = Toda la configuraci√≥n`);
                                    
                                    if (loadComplete) {
                                        groups = data.groups;
                                        renderGroups();
                                        saveConfig();
                                        alert(`‚úÖ Cargados solo ${data.groups.length} grupos de la configuraci√≥n completa`);
                                    } else {
                                        // Cargar configuraci√≥n completa
                                        groups = data.groups || [];
                                        document.getElementById('message-text').value = data.messageText || '';
                                        document.getElementById('message-type').value = data.messageType || 'text';
                                        document.getElementById('file-url').value = data.fileUrl || '';
                                        document.getElementById('delay').value = data.delay || 8;
                                        
                                        renderGroups();
                                        toggleMessageType();
                                        saveConfig();
                                        alert(`‚úÖ Configuraci√≥n completa cargada\n\nGrupos: ${groups.length}\nMensaje: ${data.messageText ? 'Cargado' : 'Vac√≠o'}`);
                                    }
                                }
                            }
                        } catch (error) {
                            alert('Error al cargar el archivo: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // Guardar plantilla
        function saveTemplate() {
            const text = document.getElementById('message-text').value;
            if (!text) {
                alert('Escribe un mensaje primero');
                return;
            }
            
            const template = {
                text: text,
                messageType: document.getElementById('message-type').value,
                fileUrl: document.getElementById('file-url').value,
                createdDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla-mensaje-whatsapp.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Exportar configuraci√≥n
        function exportConfig() {
            const config = {
                groups: groups,
                messageText: document.getElementById('message-text').value,
                messageType: document.getElementById('message-type').value,
                fileUrl: document.getElementById('file-url').value,
                delay: document.getElementById('delay').value,
                lastSendingConfig: lastSendingConfig,
                exportDate: new Date().toISOString(),
                version: '2.1-mejorada'
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'whatsapp-bulk-config-mejorado.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Mostrar ayuda
        function showHelp() {
            alert(`
üìñ Gu√≠a de Uso - Versi√≥n 2.1 MEJORADA

üÜï MEJORAS EN ESTA VERSI√ìN:
‚Ä¢ üîç Mejor detecci√≥n de c√≥digos de invitaci√≥n
‚Ä¢ üìé Reenv√≠o CON archivos adjuntos incluidos
‚Ä¢ ‚úÖ Validaci√≥n mejorada para evitar duplicados
‚Ä¢ üìä Mejor seguimiento de errores y reintentos

1Ô∏è‚É£ Configuraci√≥n:
‚Ä¢ Obt√©n tu API Key en textmebot.com
‚Ä¢ Ingresa tu API Key y verifica la conexi√≥n

2Ô∏è‚É£ Agregar Grupos (MEJORADO):
‚Ä¢ Pega el enlace completo: https://chat.whatsapp.com/CODIGO
‚Ä¢ O solo el c√≥digo: RTiy3mHqIDfD22H1InRR5E
‚Ä¢ Ingresa el nombre del grupo
‚Ä¢ El sistema valida duplicados autom√°ticamente

3Ô∏è‚É£ Crear Mensaje:
‚Ä¢ Escribe tu mensaje con variables: {grupo}, {fecha}, {hora}
‚Ä¢ Selecciona tipo de archivo si necesitas adjuntar
‚Ä¢ Vista previa muestra archivos adjuntos

4Ô∏è‚É£ Enviar (MEJORADO):
‚Ä¢ Revisa el resumen (incluye info de archivos)
‚Ä¢ üîÑ El reenv√≠o a grupos con errores INCLUYE archivos
‚Ä¢ Filtros para ver solo √©xitos/errores
‚Ä¢ ‚ö†Ô∏è IMPORTANTE: Debes ser miembro de todos los grupos

üÜï FUNCI√ìN CLAVE: REENV√çO CON ARCHIVOS
‚Ä¢ Despu√©s del env√≠o, si hay errores aparecer√° panel amarillo
‚Ä¢ Click "Reintentar Solo Errores (CON ARCHIVOS)"
‚Ä¢ El sistema reenviar√° TODO: texto + archivos

üõ†Ô∏è Consejos:
‚Ä¢ Usa retraso de 8-10 segundos entre env√≠os
‚Ä¢ Los archivos deben ser URLs p√∫blicas
‚Ä¢ El reenv√≠o ahora incluye archivos adjuntos
‚Ä¢ Valida que no hay duplicados antes de agregar

üé® Esta es la Versi√≥n 2.1 MEJORADA
‚úÖ Soluciona problemas de detecci√≥n de grupos
‚úÖ Soluciona problemas de reenv√≠o sin archivos
            `);
        }
        
        // Mostrar alertas
        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        // Guardar configuraci√≥n
        function saveConfig() {
            const config = {
                apikey: document.getElementById('apikey').value,
                delay: document.getElementById('delay').value,
                groups: groups,
                messageText: document.getElementById('message-text').value,
                messageType: document.getElementById('message-type').value,
                fileUrl: document.getElementById('file-url').value,
                linkUrl: document.getElementById('link-url').value, // Guardamos la URL del enlace
                sortDirection: sortDirection,
                lastSendingConfig: lastSendingConfig,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('whatsapp-bulk-config-mejorado', JSON.stringify(config));
        }
        
        // Cargar configuraci√≥n
        function loadConfig() {
            const saved = localStorage.getItem('whatsapp-bulk-config-mejorado');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('apikey').value = config.apikey || '';
                    document.getElementById('delay').value = config.delay || 8;
                    groups = config.groups || [];
                    document.getElementById('message-text').value = config.messageText || '';
                    document.getElementById('message-type').value = config.messageType || 'text';
                    document.getElementById('file-url').value = config.fileUrl || '';
                    document.getElementById('link-url').value = config.linkUrl || ''; // Cargamos la URL del enlace
                    sortDirection = config.sortDirection || 'asc';
                    lastSendingConfig = config.lastSendingConfig || null;
                    
                    renderGroups();
                    toggleMessageType();
                    
                    // Actualizar indicador de orden
                    const indicator = document.getElementById('sort-indicator');
                    if (indicator) {
                        indicator.textContent = sortDirection === 'asc' ? 'A-Z' : 'Z-A';
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            }
        }
    </script>
</body>
</html>
